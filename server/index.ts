import express, { type Request, Response, NextFunction } from "express";
import { registerRoutes } from "./routes";
import { setupVite, serveStatic, log } from "./vite";
import fileUpload from "express-fileupload";
import path from "path";
import session from "express-session";
import { db, sql } from "./db";
import { seedData } from "./seed-data";
import MemoryStore from 'memorystore';
import { startTelegramBot } from "./telegram-bot";

const MemoryStoreSession = MemoryStore(session);

const app = express();

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù…Ø¹ ØªØ®Ø²ÙŠÙ† Ù…Ø­Ø³Ù† Ù„Ù„Ø°Ø§ÙƒØ±Ø©
app.use(session({
  store: new MemoryStoreSession({
    checkPeriod: 86400000 // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©
  }),
  secret: process.env.SESSION_SECRET || 'your-secret-key',
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production',
    maxAge: 86400000 // 24 Ø³Ø§Ø¹Ø©
  }
}));

app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(fileUpload({
  limits: { fileSize: 50 * 1024 * 1024 }, // Ø­Ø¯ Ø£Ù‚ØµÙ‰ 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
  useTempFiles: true,
  tempFileDir: '/tmp/'
}));

// Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ø¨Ø´ÙƒÙ„ Ø«Ø§Ø¨Øª
app.use("/uploads", express.static(path.join(process.cwd(), "uploads")));

// ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨
app.use((req, res, next) => {
  const start = Date.now();
  const path = req.path;
  let capturedJsonResponse: Record<string, any> | undefined = undefined;

  const originalResJson = res.json;
  res.json = function (bodyJson, ...args) {
    capturedJsonResponse = bodyJson;
    return originalResJson.apply(res, [bodyJson, ...args]);
  };

  res.on("finish", () => {
    const duration = Date.now() - start;
    if (path.startsWith("/api")) {
      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;
      if (capturedJsonResponse) {
        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;
      }

      if (logLine.length > 80) {
        logLine = logLine.slice(0, 79) + "â€¦";
      }

      log(logLine);
    }
  });

  next();
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
const errorHandler = (err: any, _req: Request, res: Response, next: NextFunction) => {
  console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±:', err);

  if (res.headersSent) {
    return next(err);
  }

  const status = err.status || err.statusCode || 500;
  const message = err.message || "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±";

  res.status(status).json({ 
    error: true,
    message 
  });
};

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
process.on('uncaughtException', (error) => {
  console.error('Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', error);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('ÙˆØ¹Ø¯ Ù…Ø±ÙÙˆØ¶ ØºÙŠØ± Ù…Ø¹Ø§Ù„Ø¬:', promise, 'Ø§Ù„Ø³Ø¨Ø¨:', reason);
});

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ±
async function startServer() {
  try {
    // Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    console.log('Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    try {
      const result = await db.execute(sql`SELECT 1`);
      console.log('Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', result);
      console.log('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    } catch (dbError) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', dbError);
      throw dbError;
    }

    const server = await registerRoutes(app);
    app.use(errorHandler);

    if (app.get("env") === "development") {
      await setupVite(app, server);
    } else {
      serveStatic(app);
    }

    const port = 5000;
    server.listen({
      port,
      host: "0.0.0.0",
      reusePort: true,
    }, () => {
      console.log(`âœ… Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° ${port}`);

      // Ø¨Ø¯Ø¡ Ø¨ÙˆØª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…
      console.log('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø¨ÙˆØª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…...');
      startTelegramBot().catch(err => {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø¨ÙˆØª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…:', err);
      });
    });

    // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø°ÙˆØ± Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ±
    await seedData().catch(err => {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø°ÙˆØ±:", err);
    });

  } catch (error) {
    console.error('ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ±:', error);
    process.exit(1);
  }
}

startServer();